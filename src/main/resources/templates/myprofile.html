<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œí•„ í˜ì´ì§€</title>
    <link rel="stylesheet" href="/CSS/myprofile.css">
    <link rel="stylesheet" th:href="@{/CSS/Navber.css}">
    <link
            href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
            rel="stylesheet"
    />
</head>
<body>
<div th:replace="~{navbar :: navbar}"></div>
<!-- ì‚¬ì´ë“œë°” -->
<div class="sidebar">
    <div class="sidebar-item">
        <a th:if="${loggedInUserId != null}"
           th:href="@{/profile/user/{id}(id=${loggedInUserId})}"
           class="sidebar-link">
            <span class="sidebar-icon">ğŸ </span> í”„ë¡œí•„ í™ˆ
        </a>
    </div>
    <div class="sidebar-item">
        <a th:href="@{/}" class="sidebar-link">
            <span class="sidebar-icon">ğŸ“‹</span> ì‘í’ˆ ê´€ë¦¬
        </a>
    </div>
    <div class="sidebar-item">
        <a th:href="@{/}" class="sidebar-link">
            <span class="sidebar-icon">âœï¸</span> ì‘í’ˆ ë“±ë¡
        </a>
    </div>
    <div class="sidebar-item">
        <a th:href="@{/}" class="sidebar-link">
            <span class="sidebar-icon">â¤ï¸</span> ê´€ì‹¬ ì‘í’ˆ
        </a>
    </div>
    <div class="sidebar-item">
        <a th:href="@{/}" class="sidebar-link">
            <span class="sidebar-icon">âœ‰ï¸</span> ìª½ì§€í•¨
        </a>
    </div>
    <div class="sidebar-item">
        <a th:href="@{/profile/user/{id}/modify(id=${id})}" class="sidebar-link">
            <span class="sidebar-icon">ğŸ–Šï¸</span> ì •ë³´ ìˆ˜ì •
        </a>
    </div>
</div>

<!-- í”„ë¡œí•„ í™ˆ -->
<div class="profile_home">
    <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ ì˜ì—­ -->
    <div class="profile-container">
        <!-- ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID -->
        <input type="hidden" id="loggedInUserId" th:value="${loggedInUserId}">

        <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
        <img
                id="profileImage"
                th:src="${session.profileImageUrl}"
                class="profile-img"
                onclick="selectImageFile()"
        >

        <!-- íŒŒì¼ ì—…ë¡œë“œ -->
        <input type="file" id="imageFile" accept="image/*" style="display: none;" onchange="initCropper()">
    </div>

    <!-- í¬ë¡­ ì´ë¯¸ì§€ ì˜ì—­ (í¬ë¡­ í›„ ì‚¬ìš©ìê°€ í™•ì¸ ê°€ëŠ¥í•œ ì´ë¯¸ì§€ í‘œì‹œ) -->
    <div class="crop-container" id="cropContainer" style="display: none;">
        <img id="croppedImage" class="cropped-img">
        <div class="crop-buttons">
            <button id="saveButton" onclick="uploadCroppedImage()">ì €ì¥</button>
            <button id="cancelButton" onclick="cancelCrop()">ì·¨ì†Œ</button>
        </div>
    </div>
    <div class="my-info">
        <div class="profile_nickname">ë‹‰ë„¤ì„ :</div>
        <div id="profile-nickname" th:text="${nickname}"></div>
        <div class="email">Email :</div>
        <div id="profile-email" th:text="${email}"></div>
        <div id="description" th:text="${description}"></div>
    </div>
</div>

<script>
    let cropper;
    let croppedCanvas;

    function selectImageFile() {
        // í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ íŒŒì¼ ì„ íƒ ì°½ì„ ì—½ë‹ˆë‹¤.
        document.getElementById('imageFile').click();
    }

    function initCropper() {
        const imageFile = document.getElementById('imageFile').files[0];
        if (imageFile) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const imageElement = document.getElementById('croppedImage');
                imageElement.src = e.target.result;

                // í¬ë¡­ ì»¨í…Œì´ë„ˆ ë³´ì´ê¸°
                document.getElementById('cropContainer').style.display = 'block';

                // ê¸°ì¡´ í¬ë¡œí¼ê°€ ìˆì„ ê²½ìš° ì œê±° í›„ ë‹¤ì‹œ ì´ˆê¸°í™”
                if (cropper) {
                    cropper.destroy();
                }

                // Cropper.js ì´ˆê¸°í™”
                cropper = new Cropper(imageElement, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 1,
                    movable: true,
                    zoomable: true,
                    rotatable: true,
                    scalable: true,
                    cropBoxResizable: false,
                    background: false,
                    modal: true
                });
            };
            reader.readAsDataURL(imageFile);
        }
    }

    function uploadCroppedImage() {
        if (!cropper) return; // í¬ë¡œí¼ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì¢…ë£Œ

        croppedCanvas = cropper.getCroppedCanvas();
        croppedCanvas.toBlob((blob) => {
            let formData = new FormData();
            formData.append('image', blob, 'profile.png'); // í¬ë¡­ëœ ì´ë¯¸ì§€ë¥¼ Blobìœ¼ë¡œ ì¶”ê°€

            // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì IDë¥¼ ê°€ì ¸ì™€ URLì„ ìƒì„±
            const loggedInUserIdElement = document.getElementById("loggedInUserId");
            console.log("í˜„ì¬ loggedInUserIdElement:", loggedInUserIdElement); // ìš”ì†Œ í™•ì¸
             console.log("í˜„ì¬ loggedInUserId ê°’:", loggedInUserIdElement?.value); // ê°’ í™•ì¸
            if (!loggedInUserIdElement || !loggedInUserIdElement.value) {
                alert("ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const loggedInUserId = loggedInUserIdElement.value;

            // ì´ë¯¸ì§€ ì—…ë¡œë“œ ìš”ì²­
            fetch(`http://localhost:8080/profile/user/${loggedInUserId}/upload-image`, {
                method: 'POST',
                body: formData,
                credentials: 'include' // ì¸ì¦ëœ ìš”ì²­ì„ ìœ„í•´ ì¿ í‚¤ í¬í•¨
            }).then(response => {
                if (response.ok) {
                    response.text().then((imagePath) => {
                        // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ ì—…ë°ì´íŠ¸
                        document.getElementById('profileImage').src = `${imagePath}?t=${new Date().getTime()}`;
                        alert('í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ');
                        // í¬ë¡­ ì˜ì—­ ìˆ¨ê¸°ê¸°
                        document.getElementById('cropContainer').style.display = 'none';
                    });
                } else {
                    alert('í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨');
                }
            }).catch(error => {
                console.error('ì—ëŸ¬ ë°œìƒ:', error);
            });
        }, 'image/png');
    }

    function cancelCrop() {
        // í¬ë¡­ ì‘ì—… ì·¨ì†Œ ì‹œ í¬ë¡­ ì˜ì—­ ìˆ¨ê¸°ê¸°
        document.getElementById('cropContainer').style.display = 'none';
        if (cropper) {
            cropper.destroy(); // í¬ë¡œí¼ ì œê±°
        }
        document.getElementById('croppedImage').src = ''; // í¬ë¡­ëœ ì´ë¯¸ì§€ ì´ˆê¸°í™”
    }
</script>

<!-- í¬ë¡œí¼ css -->
<!-- Cropper.js CSS -->
<!-- Cropper.js JavaScript -->
<script
        src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"
></script>
<script src="/JS/dropdown.js"></script>
</body>
</html>