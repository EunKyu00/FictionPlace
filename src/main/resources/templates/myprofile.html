<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œí•„ í˜ì´ì§€</title>
    <link rel="stylesheet" href="/CSS/myprofile.css">
    <link rel="stylesheet" th:href="@{/CSS/Navber.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
</head>
<body>
<div th:replace="~{navbar :: navbar}"></div>

<!-- ì‚¬ì´ë“œë°” -->
<div class="sidebar">
    <div class="sidebar-item">
        <a th:href="@{/}" class="sidebar-link">
            <span class="sidebar-icon">ğŸ </span> í”„ë¡œí•„ í™ˆ
        </a>
    </div>
    <div class="sidebar-item">
        <a th:href="@{/webtoon/create}" class="sidebar-link">
            <span class="sidebar-icon">âœï¸</span> ì‘í’ˆ ë“±ë¡
        </a>
    </div>
    <div class="sidebar-item">
        <a th:href="@{/my/webtoon}" class="sidebar-link">
            <span class="sidebar-icon">ğŸ“‹</span> ì‘í’ˆ ê´€ë¦¬
        </a>
    </div>
    <div class="sidebar-item">
        <a th:href="@{/}" class="sidebar-link">
            <span class="sidebar-icon">â¤ï¸</span> ê´€ì‹¬ ì‘í’ˆ
        </a>
    </div>
    <div class="sidebar-item">
        <a th:href="@{/}" class="sidebar-link">
            <span class="sidebar-icon">âœ‰ï¸</span> ìª½ì§€í•¨
        </a>
    </div>
    <div class="sidebar-item">
        <a th:href="@{/profile/user/{id}/modify(id=${id})}" class="sidebar-link">
            <span class="sidebar-icon">ğŸ–Šï¸</span> ì •ë³´ ìˆ˜ì •
        </a>
    </div>
</div>

<!-- í”„ë¡œí•„ í™ˆ -->
<div class="profile_home">
    <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ ì˜ì—­ -->
    <div class="profile-container">
        <!-- ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID -->
        <input type="hidden" id="loggedInUserId" th:value="${loggedInUserId}">

        <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
        <img
                id="profileImage"
                th:src="${session.profileImageUrl}"
                class="profile-img"
                onclick="selectImageFile()"
        >

        <!-- íŒŒì¼ ì—…ë¡œë“œ -->
        <input type="file" id="imageFile" accept="image/*" style="display: none;" onchange="initCropper()">
    </div>

    <!-- ë¡œê·¸ì¸ëœ ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´ ì¶œë ¥ -->
    <div class="profile-info">
        <!-- ì¼ë°˜ ì‚¬ìš©ìë§Œ ë‹‰ë„¤ì„ì„ í‘œì‹œ -->
        <div class="profile-nickname" th:if="${nickname}">
            <strong>ë‹‰ë„¤ì„:</strong>
            <span th:text="${nickname}"></span>
        </div>

        <div class="profile-email">
            <strong>ì´ë©”ì¼:</strong>
            <span th:text="${email}"></span>
        </div>

        <div class="profile-company" th:if="${companyName}">
            <strong>íšŒì‚¬ëª…:</strong>
            <span th:text="${companyName}"></span>
        </div>
    </div>

    <!-- í¬ë¡­ ì´ë¯¸ì§€ ì˜ì—­ (í¬ë¡­ í›„ ì‚¬ìš©ìê°€ í™•ì¸ ê°€ëŠ¥í•œ ì´ë¯¸ì§€ í‘œì‹œ) -->
    <div class="crop-container" id="cropContainer" style="display: none;">
        <img id="croppedImage" class="cropped-img">
        <div class="crop-buttons">
            <button id="saveButton" onclick="uploadCroppedImage()">ì €ì¥</button>
            <button id="cancelButton" onclick="cancelCrop()">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
    let cropper;
    let croppedCanvas;

    function selectImageFile() {
        document.getElementById('imageFile').click();
    }

    function initCropper() {
        const imageFile = document.getElementById('imageFile').files[0];
        if (imageFile) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const imageElement = document.getElementById('croppedImage');
                imageElement.src = e.target.result;

                document.getElementById('cropContainer').style.display = 'block';

                if (cropper) {
                    cropper.destroy();
                }

                cropper = new Cropper(imageElement, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 1,
                    movable: true,
                    zoomable: true,
                    rotatable: true,
                    scalable: true,
                    cropBoxResizable: false,
                    background: false,
                    modal: true
                });
            };
            reader.readAsDataURL(imageFile);
        }
    }

    function uploadCroppedImage() {
        if (!cropper) return;

        croppedCanvas = cropper.getCroppedCanvas();
        croppedCanvas.toBlob((blob) => {
            let formData = new FormData();
            formData.append('image', blob, 'profile.png');

            const loggedInUserIdElement = document.getElementById('loggedInUserId');
            if (!loggedInUserIdElement || !loggedInUserIdElement.value) {
                alert("ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const loggedInUserId = loggedInUserIdElement.value;

            fetch(`http://localhost:8080/profile/user/${loggedInUserId}/upload-image`, {
                method: 'POST',
                body: formData,
                credentials: 'include'
            }).then(response => {
                if (response.ok) {
                    response.text().then((imagePath) => {
                        document.getElementById('profileImage').src = `${imagePath}?t=${new Date().getTime()}`;
                        alert('í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ');
                        document.getElementById('cropContainer').style.display = 'none';
                    });
                } else {
                    alert('í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨');
                }
            }).catch(error => {
                console.error('ì—ëŸ¬ ë°œìƒ:', error);
            });
        }, 'image/png');
    }

    function cancelCrop() {
        document.getElementById('cropContainer').style.display = 'none';
        if (cropper) {
            cropper.destroy();
        }
        document.getElementById('croppedImage').src = '';
    }
</script>

<!-- Cropper.js CSS ë° JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
</body>
</html>
